# Project Overview

Frontend: https://github.com/Amrutha-A-J/MJ_FB_Frontend
Backend: https://github.com/Amrutha-A-J/MJ_FB_Backend
Run `npm run migrate` to apply TypeScript database migrations from `src/migrations`.


## Requirements

- Node.js 22 or later is required for native `fetch` support; earlier versions are not supported.

## Environment Variables

`PG_HOST` – PostgreSQL host.

`PG_PORT` – PostgreSQL port.

`PG_USER` – PostgreSQL username.

`PG_PASSWORD` – PostgreSQL password.

`PG_DATABASE` – PostgreSQL database name.

`FRONTEND_ORIGIN` – Comma-separated list of frontend origin URLs allowed for CORS. Empty entries are ignored. Defaults to `http://localhost:5173,http://127.0.0.1:5173` if unset.

`JWT_SECRET` – Secret key used to sign and verify JSON Web Tokens. **Required**. Generate a strong random value (e.g., `openssl rand -hex 32`).

`JWT_REFRESH_SECRET` – Secret key used to sign refresh JSON Web Tokens. **Required**. Use a value different from `JWT_SECRET`.

`COOKIE_DOMAIN` – Optional domain attribute for authentication cookies. Set when cookies should be shared across subdomains.

Authentication cookies are scoped to the `/` path and use the same options when cleared.

`PORT` – Port for the backend server.

`BREVO_API_KEY` – Brevo API key for sending transactional emails.

`BREVO_FROM_EMAIL` – Email address used as the sender.

`BREVO_FROM_NAME` – Optional display name for the sender.

`PASSWORD_SETUP_TOKEN_TTL_HOURS` – Hours until password setup tokens expire (default 24).

`PASSWORD_SETUP_TEMPLATE_ID` – Brevo template ID used for password setup emails (default 6).

`BOOKING_CONFIRMATION_TEMPLATE_ID` – Brevo template ID for booking confirmation emails.

`BOOKING_REMINDER_TEMPLATE_ID` – Brevo template ID for booking reminder emails.

`VOLUNTEER_BOOKING_CONFIRMATION_TEMPLATE_ID` – Brevo template ID for volunteer booking confirmations.

`VOLUNTEER_BOOKING_REMINDER_TEMPLATE_ID` – Brevo template ID for volunteer shift reminder emails.
`VOLUNTEER_NO_SHOW_NOTIFICATION_TEMPLATE_ID` – Brevo template ID for volunteer no-show notification emails.

`VOLUNTEER_NO_SHOW_HOURS` – Hours to wait before marking a volunteer shift as no-show (default 24).

Booking confirmation and reminder templates can surface Google and Outlook calendar links by
referencing `{{ params.googleCalendarLink }}` and `{{ params.outlookCalendarLink }}` in the Brevo
templates. These URLs are generated by the backend; no additional configuration is needed beyond
setting the appropriate template IDs above.

Tests load required environment variables from `.env.test`, which Jest reads via `tests/loadEnv.ts`. Run `npm test` so this setup executes, and update `.env.test` when adding new environment settings.

## Booking Notes

Clients may include a **client note** when booking. Staff can record a **staff note** when marking a visit in the pantry schedule. Staff users automatically receive staff notes from `/bookings/history`; agency users can append `includeStaffNotes=true` to retrieve them. The `notes` query parameter filters history by note text.

Booking history joins bookings with `client_visits` and only exposes `staff_note` when the requester is staff or `includeStaffNotes=true`.

## Password Policy

Passwords must be at least 8 characters long and include at least one uppercase letter, one lowercase letter, one number, and one special character. Requests with weak passwords are rejected before hashing.

## Authentication Tokens

Login responses now return a JSON Web Token (JWT) instead of a simple `type:id` string. Clients must send this token in the `Authorization` header using the standard Bearer format:

```
Authorization: Bearer <token>
```

The token payload includes the user's `id`, `role`, and `type` and expires after one hour.

## Donation Aggregations Endpoint

`GET /donations/aggregations?year=YYYY`

Returns a list of donors with their total donated weight for each month of the specified year.
Every donor in the system is included even if they have no donations in that year; months
without records report `0`.



## Warehouse Overall Available Years Endpoint

`GET /warehouse-overall/years`

Returns an array of years for which warehouse summary data exists, ordered from most recent to oldest.
