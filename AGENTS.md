# Repository Instructions

- For changes in `MJ_FB_Backend`, run `npm test` from the `MJ_FB_Backend` directory.
- For changes in `MJ_FB_Frontend`, run `npm test` from the `MJ_FB_Frontend` directory.

## Application Structure
- `MJ_FB_Backend`: Node.js + Express API written in TypeScript.
  - `controllers/` contain business logic for each resource.
  - `routes/` expose REST endpoints and connect to controllers.
  - `models/` and `db.ts` manage PostgreSQL access.
  - `middleware/` holds reusable Express middleware (authentication, validation, etc.).
  - `schemas/`, `types/`, and `utils/` centralize validation, shared types, and helpers.
- `MJ_FB_Frontend`: React app built with Vite.
  - `pages/` define top-level views.
  - `components/` provide reusable UI elements like `FeedbackSnackbar` for user notifications.
  - `api/` wraps server requests.
  - `utils/`, `types.ts`, and theming files manage helpers, typings, and Material UI themes.

## Basic Requirements
- Preserve the separation between controllers, routes, models, and middleware in the backend.
- Use Zod schemas for validation and keep TypeScript types in sync.
- In the frontend, favor composition of reusable components and keep pages focused on layout and data flow.
- Use `FeedbackSnackbar` for user feedback instead of custom alert implementations.
- Document new environment variables in the repository README and `.env.example` files.

## User and Staff Functionality
- **Users** are clients of the Moose Jaw Food Bank who book pantry appointments through a React calendar. Selecting a day and time slot creates a record in `bookings` with status `submitted` (pending).
- **Staff** are employees with elevated roles who manage these bookings:
  - Pending bookings appear on the staff Pending page with Approve and Reject buttons.
  - The Pantry schedule's Schedule view marks pending slots with a light orange background and approved slots in green.
  - Staff can assign a user directly to a slot for instant approval, or click any booked slot to cancel or reschedule it (cancellation requires a reason).
  - Pending appointments can be rejected or rescheduled by clicking them; rejections require a reason.
- Users can view a booking history table listing all pending and approved appointments, each with Cancel and Reschedule options.

### Database Tables
```sql
CREATE TABLE IF NOT EXISTS users (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    first_name text,
    last_name text,
    email text UNIQUE,
    phone text,
    password text NOT NULL,
    client_id bigint NOT NULL UNIQUE CHECK (client_id >= 1 AND client_id <= 9999999),
    role text NOT NULL CHECK (role IN ('shopper', 'delivery')),
    bookings_this_month integer DEFAULT 0,
    booking_count_last_updated timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS bookings (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id integer,
    slot_id integer,
    status text NOT NULL CHECK (status = ANY (ARRAY['submitted', 'approved', 'rejected', 'preapproved', 'cancelled'])),
    request_data text,
    date date,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    is_staff_booking boolean DEFAULT false,
    reschedule_token text,
    FOREIGN KEY (slot_id) REFERENCES public.slots(id),
    FOREIGN KEY (user_id) REFERENCES public.users(id)
);
```
