# Repository Instructions

- For changes in `MJ_FB_Backend`, run `npm test` from the `MJ_FB_Backend` directory.
- For changes in `MJ_FB_Frontend`, run `npm test` from the `MJ_FB_Frontend` directory.

## Application Structure
- `MJ_FB_Backend`: Node.js + Express API written in TypeScript.
  - `controllers/` contain business logic for each resource.
  - `routes/` expose REST endpoints and connect to controllers.
  - `models/` and `db.ts` manage PostgreSQL access.
  - `middleware/` holds reusable Express middleware (authentication, validation, etc.).
  - `schemas/`, `types/`, and `utils/` centralize validation, shared types, and helpers.
- `MJ_FB_Frontend`: React app built with Vite.
  - `pages/` define top-level views.
  - `components/` provide reusable UI elements like `FeedbackSnackbar` for user notifications.
  - `api/` wraps server requests.
  - `utils/`, `types.ts`, and theming files manage helpers, typings, and Material UI themes.

## Functional Overview
### Backend
- The Express server configures CORS, initializes default slots, and mounts route modules for users, slots, bookings, holidays, blocked slots, breaks, staff, volunteer roles and bookings, and authentication before starting the service
- Booking logic checks slot capacity, enforces monthly visit limits, and sends confirmation emails when a booking is created
- JWT-based middleware extracts tokens from headers or cookies, verifies them, and loads the matching staff, user, or volunteer record from PostgreSQL
- A setup script provisions PostgreSQL tables for slots, users, staff, volunteer roles, bookings, breaks, and related data when the server starts

### Frontend
- The React app manages authentication for shoppers, staff, and volunteers, switching between login components and role-specific navigation/routes such as slot booking, schedule management, and volunteer coordination
- `SlotBooking` provides a calendar view that excludes weekends and holidays, fetches available slots, and submits bookings via the API
- Staff manage holidays, blocked slots, and staff breaks through `ManageAvailability`, which pulls data from and sends updates to the backend API
- Volunteers view role-specific schedules and request, cancel, or reschedule bookings through `VolunteerSchedule`
- Reusable Material UI components include a responsive `Navbar` and a `FeedbackSnackbar` for consistent UI and notifications

## Basic Requirements
- Preserve the separation between controllers, routes, models, and middleware in the backend.
- Use Zod schemas for validation and keep TypeScript types in sync.
- In the frontend, favor composition of reusable components and keep pages focused on layout and data flow.
- Use `FeedbackSnackbar` for user feedback instead of custom alert implementations.
- Document new environment variables in the repository README and `.env.example` files.

## User and Staff Functionality
- **Users** are clients of the Moose Jaw Food Bank who book pantry appointments through a React calendar. Selecting a day and time slot creates a record in `bookings` with status `submitted` (pending).
- **Staff** are employees with elevated roles who manage these bookings:
  - Pending bookings appear on the staff Pending page with Approve and Reject buttons.
  - The Pantry schedule's Schedule view marks pending slots with a light orange background and approved slots in green.
  - Staff can assign a user directly to a slot for instant approval, or click any booked slot to cancel or reschedule it (cancellation requires a reason).
  - Pending appointments can be rejected or rescheduled by clicking them; rejections require a reason.
- Users can view a booking history table listing all pending and approved appointments, each with Cancel and Reschedule options.

### Database Tables
```sql
CREATE TABLE IF NOT EXISTS users (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    first_name text,
    last_name text,
    email text UNIQUE,
    phone text,
    password text NOT NULL,
    client_id bigint NOT NULL UNIQUE CHECK (client_id >= 1 AND client_id <= 9999999),
    role text NOT NULL CHECK (role IN ('shopper', 'delivery')),
    bookings_this_month integer DEFAULT 0,
    booking_count_last_updated timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS bookings (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id integer,
    slot_id integer,
    status text NOT NULL CHECK (status = ANY (ARRAY['submitted', 'approved', 'rejected', 'preapproved', 'cancelled'])),
    request_data text,
    date date,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    is_staff_booking boolean DEFAULT false,
    reschedule_token text,
    FOREIGN KEY (slot_id) REFERENCES public.slots(id),
    FOREIGN KEY (user_id) REFERENCES public.users(id)
);
```
